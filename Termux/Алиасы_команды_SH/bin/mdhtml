#!/data/data/com.termux/files/usr/bin/bash

# ==============================================
# mdhtml - –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä md ‚Üí html
# –ó–ï–†–ö–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê + –ö–†–ê–°–ò–í–´–ï –°–¢–ò–õ–ò
# ==============================================

WORK_DIR="__WORKDIR__"
INPUT_EXT="__INPUT__"
OUTPUT_EXT="__OUTPUT__"
FOLDER_SUFFIX=" - __OUTPUT__"

# –ö—Ä–∞—Å–∏–≤—ã–µ CSS-—Å—Ç–∏–ª–∏ –ø—Ä—è–º–æ –≤ —Å–∫—Ä–∏–ø—Ç–µ
CSS_STYLES='
<style>
    body {
        font-family: "Charter", "PT Serif", Georgia, serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        font-size: 18px;
    }
    h1, h2, h3, h4, h5, h6 {
        font-family: "Montserrat", "Arial", sans-serif;
        color: #2c3e50;
        margin-top: 1.5em;
        margin-bottom: 0.5em;
    }
    h1 { font-size: 2.2em; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    h2 { font-size: 1.8em; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    h3 { font-size: 1.5em; }
    p { margin: 1em 0; }
    code {
        font-family: "JetBrains Mono", "Fira Code", monospace;
        background: #f4f4f4;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    pre {
        background: #f4f4f4;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
    }
    pre code {
        background: none;
        padding: 0;
    }
    blockquote {
        border-left: 4px solid #2c3e50;
        margin: 1em 0;
        padding: 10px 20px;
        background: #f9f9f9;
        font-style: italic;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        margin: 1em 0;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px 12px;
        text-align: left;
    }
    th {
        background: #2c3e50;
        color: white;
    }
    tr:nth-child(even) {
        background: #f9f9f9;
    }
    a {
        color: #3498db;
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
    img {
        max-width: 100%;
        height: auto;
    }
</style>
'

echo "=============================================="
echo "     mdhtml - –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä md ‚Üí html"
echo "=============================================="
echo "üìÅ –†–∞–±–æ—á–∞—è –ø–∞–ø–∫–∞: $WORK_DIR"
echo ""

if ! command -v pandoc &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é pandoc..."
    pkg install -y pandoc
fi

mkdir -p "$WORK_DIR"

TOTAL_FILES=0
CONVERTED_FILES=0

echo "üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ .$INPUT_EXT..."
echo ""

find "$WORK_DIR" -type f -name "*.$INPUT_EXT" 2>/dev/null | while read -r file; do
    
    if [[ "$file" == *"$FOLDER_SUFFIX/"* ]]; then
        continue
    fi
    
    TOTAL_FILES=$((TOTAL_FILES + 1))
    
    file_dir=$(dirname "$file")
    filename=$(basename "$file" ".$INPUT_EXT")
    
    echo "üìÑ [$TOTAL_FILES] $filename.$INPUT_EXT"
    
    # ========== –ó–ï–†–ö–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê ==========
    if [ "$file_dir" = "$WORK_DIR" ]; then
        output_dir="$file_dir"
        echo "   ‚îî‚îÄ üìç –ö–æ—Ä–Ω–µ–≤–æ–π —Ñ–∞–π–ª"
    else
        rel_path="${file_dir#$WORK_DIR/}"
        top_folder="${rel_path%%/*}"
        sub_path="${rel_path#$top_folder}"
        target_folder="$WORK_DIR/${top_folder}${FOLDER_SUFFIX}${sub_path}"
        mkdir -p "$target_folder"
        output_dir="$target_folder"
        echo "   ‚îî‚îÄ üîÑ –ó–µ—Ä–∫–∞–ª—å–Ω–∞—è –ø–∞–ø–∫–∞: ${top_folder}${FOLDER_SUFFIX}${sub_path}/"
    fi
    
    output_file="$output_dir/$filename.$OUTPUT_EXT"
    
    # –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –° –ö–†–ê–°–ò–í–´–ú–ò –°–¢–ò–õ–Ø–ú–ò
    echo "      ‚öôÔ∏è –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é —Å CSS..."
    
    # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å CSS
    echo "$file" "$output_file" | pandoc \
        --standalone \
        --toc \
        --metadata title="$filename" \
        --metadata lang="ru" \
        -H /dev/stdin <<< "$CSS_STYLES" \
        -o "$output_file"
    
    if [ $? -eq 0 ]; then
        echo "      ‚úÖ –ì–æ—Ç–æ–≤–æ: $filename.$OUTPUT_EXT"
        CONVERTED_FILES=$((CONVERTED_FILES + 1))
    else
        echo "      ‚ùå –û—à–∏–±–∫–∞"
    fi
done

echo ""
echo "=============================================="
echo "‚úÖ –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê"
echo "üìä –ù–∞–π–¥–µ–Ω–æ: $TOTAL_FILES, –°–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: $CONVERTED_FILES"
echo "=============================================="