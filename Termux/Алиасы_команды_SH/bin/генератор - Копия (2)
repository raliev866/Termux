#!/data/data/com.termux/files/usr/bin/bash

# ==============================================
# ГЕНЕРАТОР НОВЫХ КОМАНД (ЗЕРКАЛЬНАЯ ЛОГИКА)
# Версия: 5.0 - ИДЕАЛЬНОЕ ЗЕРКАЛИРОВАНИЕ
# ==============================================

# Цвета для вывода
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}══════════════════════════════════════════════${NC}"
echo -e "${GREEN}   ГЕНЕРАТОР НОВЫХ КОМАНД (ЗЕРКАЛЬНАЯ ЛОГИКА)${NC}"
echo -e "${BLUE}══════════════════════════════════════════════${NC}\n"

echo -e "${YELLOW}📋 ЗАПОЛНИТЕ ОБЩУЮ ИНФОРМАЦИЮ:${NC}\n"

read -p "📅 Дата создания (Enter для $(date +%Y.%m.%d)): " user_date
user_date=${user_date:-$(date +%Y.%m.%d)}

read -p "✍️ Автор (Enter для Рафаэль): " user_author
user_author=${user_author:-Рафаэль}

read -p "📝 Краткое описание: " user_description
user_description=${user_description:-"Конвертирует файлы"}

echo ""
echo -e "${YELLOW}⚙️ ПАРАМЕТРЫ КОНВЕРТАЦИИ:${NC}\n"

read -p "📄 Исходный формат (md, txt, csv): " input_format
input_format=${input_format:-md}

read -p "🎯 Целевой формат (html, docx, pdf, epub, fb2): " output_format
output_format=${output_format:-html}

read -p "🔤 Название команды (только буквы): " alias_name
alias_name=${alias_name:-мдгтмл}

read -p "📁 Дополнительная папка в Documents: " user_folder
user_folder=${user_folder:-"03_md_${output_format}_${alias_name}"}

# Формируем пути
work_dir="/storage/emulated/0/Documents/${user_folder}"
work_dir=$(echo "$work_dir" | sed 's|//|/|g' | sed 's|/$||')  # Убираем двойные слеши и слеш в конце

scripts_dir="/storage/emulated/0/Documents/15_Настройки_скрипты_Termux_бекап_рестор/Алиасы_команды_SH"
output_file="$scripts_dir/$alias_name"

echo ""
echo -e "${BLUE}══════════════════════════════════════════════${NC}"
echo -e "${GREEN}🔧 Генерация скрипта...${NC}"
echo -e "${BLUE}══════════════════════════════════════════════${NC}\n"

# Создаём папку для скриптов
mkdir -p "$scripts_dir"

# -------------------- СОЗДАНИЕ ФАЙЛА С ЗЕРКАЛЬНОЙ ЛОГИКОЙ --------------------
cat > "$output_file" << 'INNER_SCRIPT'
#!/data/data/com.termux/files/usr/bin/bash

# ==============================================
# __ALIAS__ - Конвертер __INPUT__ → __OUTPUT__
# ЗЕРКАЛЬНАЯ ЛОГИКА: СОХРАНЕНИЕ СТРУКТУРЫ ПАПОК
# ==============================================
# Дата создания: __DATE__
# Автор: __AUTHOR__
# Описание: __DESCRIPTION__
# ==============================================

WORK_DIR="__WORKDIR__"
INPUT_EXT="__INPUT__"
OUTPUT_EXT="__OUTPUT__"
FOLDER_SUFFIX=" - __OUTPUT__"  # Пробел перед тире для красоты

echo "══════════════════════════════════════════════"
echo "   __ALIAS__ - Конвертер __INPUT__ → __OUTPUT__"
echo "══════════════════════════════════════════════"
echo "📁 Рабочая папка: $WORK_DIR"
echo "📁 Суффикс для папок: $FOLDER_SUFFIX"
echo ""

# Проверка pandoc
if ! command -v pandoc &> /dev/null; then
    echo "📦 Устанавливаю pandoc..."
    pkg install -y pandoc
fi

# Создаём рабочую папку, если её нет
mkdir -p "$WORK_DIR"

# Счетчики
TOTAL_FILES=0
CONVERTED_FILES=0
SKIPPED_FILES=0

echo "🔍 Поиск файлов .$INPUT_EXT..."
echo ""

# Находим все файлы с нужным расширением
find "$WORK_DIR" -type f -name "*.$INPUT_EXT" 2>/dev/null | while read -r file; do
    
    # Пропускаем файлы из папок с нашим суффиксом (чтобы не конвертировать повторно)
    if [[ "$file" == *"$FOLDER_SUFFIX/"* ]]; then
        continue
    fi
    
    TOTAL_FILES=$((TOTAL_FILES + 1))
    
    # Получаем информацию о файле
    file_dir=$(dirname "$file")
    filename=$(basename "$file" ".$INPUT_EXT")
    
    echo "📄 [$TOTAL_FILES] $filename.$INPUT_EXT"
    
    # ========== ЗЕРКАЛЬНАЯ ЛОГИКА РАСПРЕДЕЛЕНИЯ ==========
    
    if [ "$file_dir" = "$WORK_DIR" ]; then
        # СЛУЧАЙ 1: Файл в корне рабочей папки
        # Результат сохраняем РЯДОМ с оригиналом
        output_dir="$file_dir"
        echo "   └─ 📍 Корневой файл → сохраняю рядом"
    else
        # СЛУЧАЙ 2: Файл во вложенной папке
        # Получаем путь относительно рабочей папки
        rel_path="${file_dir#$WORK_DIR/}"
        
        # Выделяем имя самой верхней папки (родительской)
        top_folder="${rel_path%%/*}"
        
        # Определяем остаток пути после этой папки
        sub_path="${rel_path#$top_folder}"
        
        # ФОРМИРУЕМ НОВУЮ ПАПКУ:
        # Имя_Папки + Суффикс + остаток пути
        target_folder="$WORK_DIR/${top_folder}${FOLDER_SUFFIX}${sub_path}"
        
        # Создаем папку, если её нет
        mkdir -p "$target_folder"
        output_dir="$target_folder"
        
        echo "   └─ 🔄 Зеркальная папка: ${top_folder}${FOLDER_SUFFIX}${sub_path}/"
    fi
    
    # Итоговый путь к файлу
    output_file="$output_dir/$filename.$OUTPUT_EXT"
    
    # Проверяем, нужно ли конвертировать (идемпотентность)
    if [ -f "$output_file" ] && [ "$file" -ot "$output_file" ]; then
        echo "      ⏭️ Результат свежее исходника, пропускаю"
        SKIPPED_FILES=$((SKIPPED_FILES + 1))
        continue
    fi
    
    # Конвертация
    echo "      ⚙️ Конвертирую..."
    
    # pandoc "$file" -o "$output_file" 2>/tmp/pandoc_error
    pandoc "$file" -o "$output_file" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "      ✅ Готово: $filename.$OUTPUT_EXT"
        CONVERTED_FILES=$((CONVERTED_FILES + 1))
    else
        echo "      ❌ Ошибка конвертации"
        # cat /tmp/pandoc_error | head -3
    fi
    
    echo ""
done

echo "══════════════════════════════════════════════"
echo "✅ КОНВЕРТАЦИЯ ЗАВЕРШЕНА"
echo "📊 Найдено файлов: $TOTAL_FILES"
echo "📊 Сконвертировано: $CONVERTED_FILES"
echo "📊 Пропущено: $SKIPPED_FILES"
echo "══════════════════════════════════════════════"
echo ""
echo "📁 Файлы в корне: сохранены рядом с оригиналами"
echo "📁 Файлы в папках: зеркально отражены с суффиксом '$FOLDER_SUFFIX'"
echo "══════════════════════════════════════════════"
INNER_SCRIPT

# Заменяем плейсхолдеры на реальные значения
sed -i "s|__ALIAS__|$alias_name|g" "$output_file"
sed -i "s|__INPUT__|$input_format|g" "$output_file"
sed -i "s|__OUTPUT__|$output_format|g" "$output_file"
sed -i "s|__DATE__|$user_date|g" "$output_file"
sed -i "s|__AUTHOR__|$user_author|g" "$output_file"
sed -i "s|__DESCRIPTION__|$user_description|g" "$output_file"
sed -i "s|__WORKDIR__|$work_dir|g" "$output_file"

# Даём права
chmod +x "$output_file"
echo -e "${GREEN}✅ Скрипт создан: $output_file${NC}\n"

# Копируем в .termux_scripts
echo -e "${YELLOW}📦 Копирую в ~/.termux_scripts/...${NC}"
mkdir -p ~/.termux_scripts
cp "$output_file" ~/.termux_scripts/
chmod +x ~/.termux_scripts/"$alias_name"
echo -e "${GREEN}✅ Скопировано в: ~/.termux_scripts/$alias_name${NC}\n"

# Регистрация команды
echo -e "${YELLOW}⚙️ РЕГИСТРАЦИЯ КОМАНДЫ...${NC}\n"

unalias "$alias_name" 2>/dev/null
sed -i "/$alias_name/d" ~/.bashrc
rm -f ~/bin/"$alias_name" 2>/dev/null

mkdir -p ~/bin
ln -sf ~/.termux_scripts/"$alias_name" ~/bin/"$alias_name"
chmod +x ~/bin/"$alias_name"

if ! echo "$PATH" | grep -q "$HOME/bin"; then
    echo 'export PATH="$PATH:$HOME/bin"' >> ~/.bashrc
fi

echo "alias $alias_name='~/.termux_scripts/$alias_name'" >> ~/.bashrc
source ~/.bashrc 2>/dev/null

echo -e "${GREEN}✅ Команда '$alias_name' зарегистрирована${NC}\n"

# Проверка
echo -e "${YELLOW}🔍 ПРОВЕРКА:${NC}\n"

which_output=$(which "$alias_name" 2>/dev/null)
if [ -n "$which_output" ]; then
    echo -e "${GREEN}✅ which $alias_name → $which_output${NC}"
else
    echo -e "${RED}❌ which $alias_name → НЕ НАЙДЕНА${NC}"
fi

alias_output=$(alias | grep "$alias_name" 2>/dev/null)
if [ -n "$alias_output" ]; then
    echo -e "${GREEN}✅ alias $alias_name → $alias_output${NC}"
else
    echo -e "${RED}❌ alias $alias_name → НЕ НАЙДЕН${NC}"
fi

if [ -f ~/bin/"$alias_name" ]; then
    echo -e "${GREEN}✅ Файл в ~/bin/ существует${NC}"
else
    echo -e "${RED}❌ Файл в ~/bin/ отсутствует${NC}"
fi

echo ""
echo -e "${BLUE}══════════════════════════════════════════════${NC}"
echo -e "${GREEN}🏁 ВСЁ ГОТОВО! Команда '$alias_name' создана${NC}"
echo -e "${BLUE}══════════════════════════════════════════════${NC}"
echo ""
echo -e "${YELLOW}📁 Рабочая папка:${NC} $work_dir"
echo -e "${YELLOW}🔤 Команда для запуска:${NC} $alias_name"
echo -e "${YELLOW}📋 Суффикс для папок:${NC} $FOLDER_SUFFIX"
echo ""
echo -e "${GREEN}Пример использования:${NC}"
echo "   $alias_name"
echo "   $alias_name конкретный_файл.md"
echo ""