#!/data/data/com.termux/files/usr/bin/bash

# ==============================================
# ГЕНЕРАТОР НОВЫХ КОМАНД (С ПОДДЕРЖКОЙ CSS)
# Версия: 5.0 - С ШАБЛОНАМИ ОФОРМЛЕНИЯ
# ==============================================

# Цвета для вывода
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}══════════════════════════════════════════════${NC}"
echo -e "${GREEN}   ГЕНЕРАТОР НОВЫХ КОМАНД (С ШАБЛОНАМИ)${NC}"
echo -e "${BLUE}══════════════════════════════════════════════${NC}\n"

echo -e "${YELLOW}📋 ЗАПОЛНИТЕ ОБЩУЮ ИНФОРМАЦИЮ:${NC}\n"

read -p "📅 Дата создания (Enter для $(date +%Y.%m.%d)): " user_date
user_date=${user_date:-$(date +%Y.%m.%d)}

read -p "✍️ Автор (Enter для Рафаэль): " user_author
user_author=${user_author:-Рафаэль}

read -p "📝 Краткое описание: " user_description
user_description=${user_description:-"Конвертирует файлы"}

echo ""
echo -e "${YELLOW}⚙️ ПАРАМЕТРЫ КОНВЕРТАЦИИ:${NC}\n"

read -p "📄 Исходный формат (md, txt, csv): " input_format
input_format=${input_format:-md}

read -p "🎯 Целевой формат (html, docx, pdf, epub, fb2): " output_format
output_format=${output_format:-html}

read -p "🔤 Название команды (только буквы): " alias_name
alias_name=${alias_name:-мдгтмл}

read -p "📁 Дополнительная папка в Documents: " user_folder
user_folder=${user_folder:-"03_md_${output_format}_${alias_name}"}

# ===== ДОПОЛНИТЕЛЬНЫЙ ВОПРОС ДЛЯ HTML =====
CSS_TEMPLATE=""
if [ "$output_format" = "html" ]; then
    echo ""
    echo -e "${YELLOW}🎨 НАСТРОЙКА ОФОРМЛЕНИЯ HTML:${NC}\n"
    echo "Доступные шаблоны:"
    echo "   1. Научный стиль (scientific_style.css)"
    echo "   2. Шаблон научной книги (шаблон_научной_книги.html)"
    echo "   3. Без шаблона (минимальный)"
    echo ""
    read -p "Выберите номер шаблона (1/2/3): " template_choice
    
    TEMPLATE_BASE="/storage/emulated/0/Documents/15_Настройки_скрипты_Termux_бекап_рестор/Шаблон_формата_текста/HTML_книги"
    
    case $template_choice in
        1)
            CSS_TEMPLATE="$TEMPLATE_BASE/scientific_style.css"
            echo -e "${GREEN}✅ Выбран CSS-шаблон: scientific_style.css${NC}"
            ;;
        2)
            CSS_TEMPLATE="$TEMPLATE_BASE/шаблон_научной_книги.html"
            echo -e "${GREEN}✅ Выбран HTML-шаблон: шаблон_научной_книги.html${NC}"
            ;;
        *)
            CSS_TEMPLATE=""
            echo -e "${YELLOW}⚠️ Шаблон не выбран (минимальное оформление)${NC}"
            ;;
    esac
fi

# Формируем пути
work_dir="/storage/emulated/0/Documents/${user_folder}"
work_dir=$(echo "$work_dir" | sed 's|//|/|g' | sed 's|/$||')

scripts_dir="/storage/emulated/0/Documents/15_Настройки_скрипты_Termux_бекап_рестор/Алиасы_команды_SH"
output_file="$scripts_dir/$alias_name"

echo ""
echo -e "${BLUE}══════════════════════════════════════════════${NC}"
echo -e "${GREEN}🔧 Генерация скрипта...${NC}"
echo -e "${BLUE}══════════════════════════════════════════════${NC}\n"

mkdir -p "$scripts_dir"

# ===== СОЗДАНИЕ СКРИПТА С ПОДДЕРЖКОЙ ШАБЛОНОВ =====
cat > "$output_file" << INNER_SCRIPT
#!/data/data/com.termux/files/usr/bin/bash

# ==============================================
# $alias_name - Конвертер $input_format → $output_format
# С ПОДДЕРЖКОЙ ШАБЛОНОВ ОФОРМЛЕНИЯ
# ==============================================
# Дата создания: $user_date
# Автор: $user_author
# Описание: $user_description
# ==============================================

WORK_DIR="$work_dir"
INPUT_EXT="$input_format"
OUTPUT_EXT="$output_format"
FOLDER_SUFFIX=" - $output_format"

# ===== ШАБЛОН ОФОРМЛЕНИЯ =====
CSS_TEMPLATE="$CSS_TEMPLATE"

echo "══════════════════════════════════════════════"
echo "     $alias_name - Конвертер $input_format → $output_format"
echo "══════════════════════════════════════════════"
echo "📁 Рабочая папка: \$WORK_DIR"
if [ -n "\$CSS_TEMPLATE" ] && [ -f "\$CSS_TEMPLATE" ]; then
    echo "🎨 Шаблон оформления: \$CSS_TEMPLATE"
fi
echo ""

# Проверка pandoc
if ! command -v pandoc &> /dev/null; then
    echo "📦 Устанавливаю pandoc..."
    pkg install -y pandoc
fi

mkdir -p "\$WORK_DIR"

# Счетчики
TOTAL_FILES=0
CONVERTED_FILES=0
SKIPPED_FILES=0

echo "🔍 Поиск файлов .\$INPUT_EXT..."
echo ""

find "\$WORK_DIR" -type f -name "*.\$INPUT_EXT" 2>/dev/null | while read -r file; do
    
    if [[ "\$file" == *"\$FOLDER_SUFFIX/"* ]]; then
        continue
    fi
    
    TOTAL_FILES=\$((TOTAL_FILES + 1))
    
    file_dir=\$(dirname "\$file")
    filename=\$(basename "\$file" ".\$INPUT_EXT")
    
    echo "📄 [\$TOTAL_FILES] \$filename.\$INPUT_EXT"
    
    # ===== ЗЕРКАЛЬНАЯ ЛОГИКА =====
    if [ "\$file_dir" = "\$WORK_DIR" ]; then
        output_dir="\$file_dir"
        echo "   └─ 📍 Корневой файл"
    else
        rel_path="\${file_dir#\$WORK_DIR/}"
        top_folder="\${rel_path%%/*}"
        sub_path="\${rel_path#\$top_folder}"
        target_folder="\$WORK_DIR/\${top_folder}\${FOLDER_SUFFIX}\${sub_path}"
        mkdir -p "\$target_folder"
        output_dir="\$target_folder"
        echo "   └─ 🔄 Зеркальная папка: \${top_folder}\${FOLDER_SUFFIX}\${sub_path}/"
    fi
    
    output_file="\$output_dir/\$filename.\$OUTPUT_EXT"
    
    # ===== КОНВЕРТАЦИЯ С ШАБЛОНОМ =====
    echo "      ⚙️ Конвертирую..."
    
    # Формируем команду pandoc в зависимости от типа шаблона
    PANDOC_CMD="pandoc \"\$file\" -o \"\$output_file\" --standalone --toc"
    
    if [ -n "\$CSS_TEMPLATE" ] && [ -f "\$CSS_TEMPLATE" ]; then
        if [[ "\$CSS_TEMPLATE" == *.css ]]; then
            # Если это CSS-файл
            PANDOC_CMD="\$PANDOC_CMD --css=\"\$CSS_TEMPLATE\""
            echo "      🎨 Подключаю CSS: \$(basename "\$CSS_TEMPLATE")"
        elif [[ "\$CSS_TEMPLATE" == *.html ]]; then
            # Если это HTML-шаблон (можно использовать как reference)
            # Копируем CSS из HTML шаблона или используем его как основу
            cp "\$CSS_TEMPLATE" "\$output_dir/\$(basename "\$CSS_TEMPLATE")" 2>/dev/null
            echo "      📄 Использую HTML-шаблон"
        fi
    fi
    
    # Выполняем конвертацию
    eval \$PANDOC_CMD 2>/dev/null
    
    if [ \$? -eq 0 ]; then
        echo "      ✅ Готово: \$filename.\$OUTPUT_EXT"
        CONVERTED_FILES=\$((CONVERTED_FILES + 1))
    else
        echo "      ❌ Ошибка конвертации"
    fi
    
    echo ""
done

echo "══════════════════════════════════════════════"
echo "✅ КОНВЕРТАЦИЯ ЗАВЕРШЕНА"
echo "📊 Найдено: \$TOTAL_FILES"
echo "📊 Сконвертировано: \$CONVERTED_FILES"
echo "📊 Пропущено: \$SKIPPED_FILES"
echo "══════════════════════════════════════════════"
INNER_SCRIPT

chmod +x "$output_file"
echo -e "${GREEN}✅ Скрипт создан: $output_file${NC}\n"

# Копируем в .termux_scripts
mkdir -p ~/.termux_scripts
cp "$output_file" ~/.termux_scripts/
chmod +x ~/.termux_scripts/"$alias_name"
echo -e "${GREEN}✅ Скопировано в: ~/.termux_scripts/$alias_name${NC}\n"

# Регистрация команды
unalias "$alias_name" 2>/dev/null
sed -i "/$alias_name/d" ~/.bashrc
rm -f ~/bin/"$alias_name" 2>/dev/null

mkdir -p ~/bin
ln -sf ~/.termux_scripts/"$alias_name" ~/bin/"$alias_name"
chmod +x ~/bin/"$alias_name"

if ! echo "$PATH" | grep -q "$HOME/bin"; then
    echo 'export PATH="$PATH:$HOME/bin"' >> ~/.bashrc
    export PATH="$PATH:$HOME/bin"
fi

source ~/.bashrc 2>/dev/null

echo -e "${GREEN}✅ Команда '$alias_name' зарегистрирована${NC}\n"
echo -e "${BLUE}══════════════════════════════════════════════${NC}"
echo -e "${GREEN}🏁 ГОТОВО! Команда '$alias_name' создана${NC}"
echo -e "${BLUE}══════════════════════════════════════════════${NC}"
echo ""
echo -e "${YELLOW}📁 Рабочая папка:${NC} $work_dir"
echo -e "${YELLOW}🔤 Команда для запуска:${NC} $alias_name"
echo ""