#!/data/data/com.termux/files/usr/bin/bash

# ==============================================
# mb2fb2 - –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä md ‚Üí fb2
# ==============================================

WORK_DIR="/storage/emulated/0/Documents/05_–≠–ª–µ–∫—Ç_–∫–Ω–∏–≥–∏/02_md_fb2_–º–¥—Ñ–±2"
INPUT_EXT="md"
OUTPUT_EXT="fb2"
FOLDER_SUFFIX="fb2"

echo "=============================================="
echo "     mb2fb2 - –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä md ‚Üí fb2"
echo "=============================================="
echo "üìÅ –†–∞–±–æ—á–∞—è –ø–∞–ø–∫–∞: $WORK_DIR"
echo ""

if ! command -v pandoc &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é pandoc..."
    pkg install -y pandoc
fi

mkdir -p "$WORK_DIR"

FILES_FOUND=0
FILES_CONVERTED=0

echo "üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ .$INPUT_EXT..."
echo ""

find "$WORK_DIR" -type f -name "*.$INPUT_EXT" 2>/dev/null | while read full_path; do
    
    FILES_FOUND=$((FILES_FOUND + 1))
    filename=$(basename "$full_path" ".$INPUT_EXT")
    filedir=$(dirname "$full_path")
    
    echo "üìÑ [$FILES_FOUND] $filename.$INPUT_EXT"
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—á–µ–π –ø–∞–ø–∫–∏
    rel_path="${filedir#$WORK_DIR/}"
    
    if [ "$filedir" = "$WORK_DIR" ]; then
        # –§–∞–π–ª –ø—Ä—è–º–æ –≤ —Ä–∞–±–æ—á–µ–π –ø–∞–ø–∫–µ
        output_dir="${WORK_DIR} - ${FOLDER_SUFFIX}"
        mkdir -p "$output_dir"
        echo "   ‚îî‚îÄ –ü–∞–ø–∫–∞: $(basename "$output_dir")"
    else
        # –§–∞–π–ª –≤–æ –≤–ª–æ–∂–µ–Ω–Ω–æ–π –ø–∞–ø–∫–µ
        first_folder="${rel_path%%/*}"
        rest_path="${rel_path#$first_folder}"
        
        # –ü–ï–†–ï–ò–ú–ï–ù–û–í–´–í–ê–ï–ú –¢–û–õ–¨–ö–û –ü–ï–†–í–£–Æ –ü–ê–ü–ö–£
        new_first_folder="${first_folder} - ${FOLDER_SUFFIX}"
        
        # –í–°–ï –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–∞–ø–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Å original –∏–º–µ–Ω–∞–º–∏
        output_dir="${WORK_DIR}/${new_first_folder}${rest_path}"
        mkdir -p "$output_dir"
        echo "   ‚îî‚îÄ –ü–∞–ø–∫–∞: ${new_first_folder}${rest_path}"
    fi
    
    output_file="$output_dir/$filename.$OUTPUT_EXT"
    
    pandoc "$full_path" -o "$output_file"
    
    if [ $? -eq 0 ]; then
        echo "      ‚úÖ –ì–æ—Ç–æ–≤–æ: $filename.$OUTPUT_EXT"
        FILES_CONVERTED=$((FILES_CONVERTED + 1))
    else
        echo "      ‚ùå –û—à–∏–±–∫–∞"
    fi
done

echo ""
echo "=============================================="
echo "‚úÖ –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê"
echo "üìä –ù–∞–π–¥–µ–Ω–æ: $FILES_FOUND, –°–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: $FILES_CONVERTED"
echo "=============================================="
