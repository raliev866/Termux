#!/data/data/com.termux/files/usr/bin/bash

# ==============================================
# mdhtml - Конвертер md → html
# С ПОДДЕРЖКОЙ ШАБЛОНОВ ОФОРМЛЕНИЯ
# ==============================================
# Дата создания: 2026.02.25
# Автор: Рафаэль
# Описание: Конвертор md  html
# ==============================================

WORK_DIR="/storage/emulated/0/Documents/03_md_html_mdhtml"
INPUT_EXT="md"
OUTPUT_EXT="html"
FOLDER_SUFFIX=" - html"

# ===== ШАБЛОН ОФОРМЛЕНИЯ =====
CSS_TEMPLATE="/storage/emulated/0/Documents/15_Настройки_скрипты_Termux_бекап_рестор/Шаблон_формата_текста/HTML_книги/scientific_style.css"

echo "══════════════════════════════════════════════"
echo "     mdhtml - Конвертер md → html"
echo "══════════════════════════════════════════════"
echo "📁 Рабочая папка: $WORK_DIR"
if [ -n "$CSS_TEMPLATE" ] && [ -f "$CSS_TEMPLATE" ]; then
    echo "🎨 Шаблон оформления: $CSS_TEMPLATE"
fi
echo ""

# Проверка pandoc
if ! command -v pandoc &> /dev/null; then
    echo "📦 Устанавливаю pandoc..."
    pkg install -y pandoc
fi

mkdir -p "$WORK_DIR"

# Счетчики
TOTAL_FILES=0
CONVERTED_FILES=0
SKIPPED_FILES=0

echo "🔍 Поиск файлов .$INPUT_EXT..."
echo ""

find "$WORK_DIR" -type f -name "*.$INPUT_EXT" 2>/dev/null | while read -r file; do
    
    if [[ "$file" == *"$FOLDER_SUFFIX/"* ]]; then
        continue
    fi
    
    TOTAL_FILES=$((TOTAL_FILES + 1))
    
    file_dir=$(dirname "$file")
    filename=$(basename "$file" ".$INPUT_EXT")
    
    echo "📄 [$TOTAL_FILES] $filename.$INPUT_EXT"
    
    # ===== ЗЕРКАЛЬНАЯ ЛОГИКА =====
    if [ "$file_dir" = "$WORK_DIR" ]; then
        output_dir="$file_dir"
        echo "   └─ 📍 Корневой файл"
    else
        rel_path="${file_dir#$WORK_DIR/}"
        top_folder="${rel_path%%/*}"
        sub_path="${rel_path#$top_folder}"
        target_folder="$WORK_DIR/${top_folder}${FOLDER_SUFFIX}${sub_path}"
        mkdir -p "$target_folder"
        output_dir="$target_folder"
        echo "   └─ 🔄 Зеркальная папка: ${top_folder}${FOLDER_SUFFIX}${sub_path}/"
    fi
    
    output_file="$output_dir/$filename.$OUTPUT_EXT"
    
    # ===== КОНВЕРТАЦИЯ С ШАБЛОНОМ =====
    echo "      ⚙️ Конвертирую..."
    
    # Формируем команду pandoc в зависимости от типа шаблона
    PANDOC_CMD="pandoc \"$file\" -o \"$output_file\" --standalone --toc"
    
    if [ -n "$CSS_TEMPLATE" ] && [ -f "$CSS_TEMPLATE" ]; then
        if [[ "$CSS_TEMPLATE" == *.css ]]; then
            # Если это CSS-файл
            PANDOC_CMD="$PANDOC_CMD --css=\"$CSS_TEMPLATE\""
            echo "      🎨 Подключаю CSS: $(basename "$CSS_TEMPLATE")"
        elif [[ "$CSS_TEMPLATE" == *.html ]]; then
            # Если это HTML-шаблон (можно использовать как reference)
            # Копируем CSS из HTML шаблона или используем его как основу
            cp "$CSS_TEMPLATE" "$output_dir/$(basename "$CSS_TEMPLATE")" 2>/dev/null
            echo "      📄 Использую HTML-шаблон"
        fi
    fi
    
    # Выполняем конвертацию
    eval $PANDOC_CMD 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "      ✅ Готово: $filename.$OUTPUT_EXT"
        CONVERTED_FILES=$((CONVERTED_FILES + 1))
    else
        echo "      ❌ Ошибка конвертации"
    fi
    
    echo ""
done

echo "══════════════════════════════════════════════"
echo "✅ КОНВЕРТАЦИЯ ЗАВЕРШЕНА"
echo "📊 Найдено: $TOTAL_FILES"
echo "📊 Сконвертировано: $CONVERTED_FILES"
echo "📊 Пропущено: $SKIPPED_FILES"
echo "══════════════════════════════════════════════"
